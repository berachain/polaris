# Copyright (C) 2023, Berachain Foundation. All rights reserved.
# See the file LICENSE for licensing terms.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

version: 2.1

executors:
  standard:
    docker:
      - image: cimg/go:1.19
        environment:
          FOUNDRY_COMMIT: 3d5f03836dc5820ba95dadd736d0b17a3c7b4583
    resource_class: large
  machine:
    machine:
      image: ubuntu-2204:2022.04.2
    environment:
      architecture: "amd64"
      platform: "linux/amd64"
orbs:
  codecov: codecov/codecov@3.2.4

jobs:
  lint:
    executor: standard
    steps:
      - setup
      - run:
          name: Lint
          command: mage lint

  test-unit:
    executor: standard
    steps:
      - setup
      - run:
          name: Test Unit
          command: mage testunitcover
      - codecov/upload:
          file: coverage-testunitcover.txt
      - store_test_results:
          path: .
  test-unit-race:
    executor: standard
    steps:
      - setup
      - run:
          name: Test Unit Race
          command: mage testunitrace
      - store_test_results:
          path: .
  test-integration:
    executor: machine
    steps:
      - run:
          name: Upgrade Golang
          command: |
            sudo add-apt-repository ppa:gophers/go
            sudo apt-get update
            sudo apt-get install golang-stable
      - setup
      - run:
          name: Test Integration
          command: mage testintegrationcover
      - store_test_results:
          path: .

workflows:
  build_lint_test:
    jobs:
      # - build
      - lint
      - test-unit
      - test-unit-race
      - test-integration

commands:
  setup: # Setup the test environment
    steps:
      - checkout
      # Setup Golang
      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - "/home/circleci/go/pkg/mod"
            - "/home/circleci/go/pkg/bin"

      - run:
          name: Install Go Dependencies
          command: |
            go mod download

      - run:
          name: Install Go Tools
          command: |
            echo 'export PATH=/home/circleci/go/bin:"$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"
            go install github.com/magefile/mage
            go install github.com/onsi/ginkgo/v2/ginkgo

      - save_cache:
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - "/home/circleci/go/pkg/mod"
            - "/home/circleci/go/pkg/bin"

      # Setup Foundry
      - restore_cache:
          keys:
            - foundry-${FOUNDRY_COMMIT}
          paths:
            - "/home/circleci/.foundry/bin"

      - run:
          name: Install Foundryup
          command: |
            curl -L https://foundry.paradigm.xyz | bash || true
            echo 'export PATH=/home/circleci/.foundry/bin:"$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"
            foundryup

      - save_cache:
          key: foundry-${FOUNDRY_COMMIT}
          paths:
            - "/home/circleci/.foundry/bin"
